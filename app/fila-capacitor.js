"use strict";
class FilaCapacitor extends Fila {
    /** */
    static async use() {
        const cwd = this.directory.data;
        const tmp = this.directory.cache;
        const sep = "/";
        Fila.setDefaults(FilaCapacitor, sep, cwd, tmp);
    }
    /** Values copied from Capacitor. */
    static directory = {
        cache: "CACHE",
        data: "DATA",
        documents: "DOCUMENTS",
        external: "EXTERNAL",
        externalStorage: "EXTERNAL_STORAGE",
        library: "LIBRARY",
    };
    /** */
    get fs() {
        const g = globalThis;
        const fs = g.Capacitor?.Plugins?.Filesystem;
        if (!fs)
            throw new Error("Filesystem plugin not added to Capacitor.");
        return fs;
    }
    /**
     * Gets the fully-qualified path, including any file name to the
     * file system object being represented by this Fila object.
     */
    get path() {
        return Fila.join(...this.components);
    }
    /** */
    async readText() {
        const result = await this.fs.readFile({
            ...this.getDefaultOptions(),
            encoding: "utf8"
        });
        return result.data;
    }
    /** */
    async readBinary() {
        const result = await this.fs.readFile({
            ...this.getDefaultOptions(),
            encoding: "ascii"
        });
        const base64 = result.data;
        return Uint8Array.from(atob(base64), c => c.charCodeAt(0));
    }
    /** */
    async readDirectory() {
        const result = await this.fs.readdir(this.getDefaultOptions());
        const filas = [];
        for (const file of result.files)
            if (file.name !== ".DS_Store")
                filas.push(Fila.new(this.path, file.name || ""));
        return filas;
    }
    /** */
    async writeText(text, options) {
        try {
            const up = this.up();
            if (!await up.exists())
                await up.writeDirectory();
            const writeOptions = {
                ...this.getDefaultOptions(),
                data: text,
                encoding: "utf8"
            };
            if (options?.append)
                await this.fs.appendFile(writeOptions);
            else
                await this.fs.writeFile(writeOptions);
        }
        catch (e) {
            console.error("Write failed to path: " + this.path);
            debugger;
        }
    }
    /** */
    async writeBinary(arrayBuffer) {
        await this.up().writeDirectory();
        const data = await this.arrayBufferToBase64(arrayBuffer);
        await this.fs.writeFile({
            ...this.getDefaultOptions(),
            data,
            encoding: "ascii"
        });
    }
    /** */
    arrayBufferToBase64(buffer) {
        return new Promise(r => {
            const blob = new Blob([buffer], { type: "application/octet-binary" });
            const reader = new FileReader();
            reader.onload = ev => {
                const dataUrl = (ev.target?.result || "");
                const slice = dataUrl.slice(dataUrl.indexOf(`,`) + 1);
                r(slice);
            };
            reader.readAsDataURL(blob);
        });
    }
    /** */
    async writeDirectory() {
        await this.fs.mkdir({
            ...this.getDefaultOptions(),
            recursive: true
        });
    }
    /**
     * Writes a symlink file at the location represented by the specified
     * Fila object, to the location specified by the current Fila object.
     */
    async writeSymlink(at) {
        throw new Error("Not implemented");
    }
    /**
     * Deletes the file or directory that this Fila object represents.
     */
    async delete() {
        if (await this.isDirectory()) {
            return new Promise(async (r) => {
                await this.fs.rmdir({
                    ...this.getDefaultOptions(),
                    recursive: true
                });
                r();
            });
        }
        await this.fs.deleteFile(this.getDefaultOptions());
    }
    /** */
    async move(target) {
        throw new Error("Not implemented.");
    }
    /** */
    async copy(target) {
        const fromOptions = this.getDefaultOptions();
        const toOptions = this.getDefaultOptions(target.path);
        await this.fs.copy({
            from: fromOptions.path,
            directory: fromOptions.directory,
            to: toOptions.path,
            toDirectory: toOptions.directory,
        });
    }
    /** */
    async rename(newName) {
        const target = this.up().down(newName).path;
        const fromOptions = this.getDefaultOptions();
        const toOptions = this.getDefaultOptions(target);
        await this.fs.rename({
            from: this.path,
            directory: fromOptions.directory,
            to: target,
            toDirectory: toOptions.directory
        });
    }
    /** */
    watchProtected(recursive, callbackFn) {
        throw new Error("Not implemented");
    }
    /** */
    async exists() {
        return !!await this.getStat();
    }
    /** */
    async getSize() {
        return (await this.getStat())?.size || 0;
    }
    /** */
    async getModifiedTicks() {
        return (await this.getStat())?.mtime || 0;
    }
    /** */
    async getCreatedTicks() {
        return (await this.getStat())?.ctime || 0;
    }
    /** */
    async getAccessedTicks() {
        return 0;
    }
    /** */
    async isDirectory() {
        return (await this.getStat())?.type === "directory";
    }
    /** */
    async getStat() {
        try {
            return await this.fs.stat(this.getDefaultOptions());
        }
        catch (e) {
            return null;
        }
    }
    /** */
    getDefaultOptions(targetPath = this.path) {
        const slash = targetPath.indexOf("/");
        let path = "";
        let directory = "";
        if (slash < 0) {
            path = targetPath;
            directory = FilaCapacitor.directory.cache;
        }
        else {
            path = targetPath.slice(slash + 1);
            directory = targetPath.slice(0, slash);
        }
        const result = {
            path,
            directory: directory
        };
        return result;
    }
}
(function (FilaCapacitor) {
    typeof module === "object" && Object.assign(module.exports, { FilaCapacitor });
})(FilaCapacitor || (FilaCapacitor = {}));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmlsYS1jYXBhY2l0b3IuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9GaWxhQ2FwYWNpdG9yLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFDQSxNQUFNLGFBQWMsU0FBUSxJQUFJO0lBRS9CLE1BQU07SUFDTixNQUFNLENBQUMsS0FBSyxDQUFDLEdBQUc7UUFFZixNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQztRQUNoQyxNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQztRQUNqQyxNQUFNLEdBQUcsR0FBRyxHQUFHLENBQUM7UUFDaEIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxhQUFhLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLENBQUMsQ0FBQztJQUNoRCxDQUFDO0lBRUQsb0NBQW9DO0lBQ3BDLE1BQU0sQ0FBVSxTQUFTLEdBQUc7UUFDM0IsS0FBSyxFQUFFLE9BQU87UUFDZCxJQUFJLEVBQUUsTUFBTTtRQUNaLFNBQVMsRUFBRSxXQUFXO1FBQ3RCLFFBQVEsRUFBRSxVQUFVO1FBQ3BCLGVBQWUsRUFBRSxrQkFBa0I7UUFDbkMsT0FBTyxFQUFFLFNBQVM7S0FDVCxDQUFDO0lBRVgsTUFBTTtJQUNOLElBQVksRUFBRTtRQUViLE1BQU0sQ0FBQyxHQUFHLFVBQWlCLENBQUM7UUFDNUIsTUFBTSxFQUFFLEdBQUcsQ0FBQyxDQUFDLFNBQVMsRUFBRSxPQUFPLEVBQUUsVUFBVSxDQUFDO1FBQzVDLElBQUksQ0FBQyxFQUFFO1lBQ04sTUFBTSxJQUFJLEtBQUssQ0FBQywyQ0FBMkMsQ0FBQyxDQUFDO1FBRTlELE9BQU8sRUFBdUQsQ0FBQztJQUNoRSxDQUFDO0lBRUQ7OztPQUdHO0lBQ0gsSUFBSSxJQUFJO1FBRVAsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO0lBQ3RDLENBQUM7SUFFRCxNQUFNO0lBQ04sS0FBSyxD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QUMsQ0FBQztTQUNwRDtRQUNELE9BQU8sQ0FBQyxFQUFFO1lBQUUsT0FBTyxJQUFJLENBQUM7U0FBRTtJQUMzQixDQUFDO0lBRUQsTUFBTTtJQUNFLGlCQUFpQixDQUFDLGFBQXFCLElBQUksQ0FBQyxJQUFJO1FBRXZELE1BQU0sS0FBSyxHQUFHLFVBQVUsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDdEMsSUFBSSxJQUFJLEdBQUcsRUFBRSxDQUFDO1FBQ2QsSUFBSSxTQUFTLEdBQUcsRUFBRSxDQUFDO1FBRW5CLElBQUksS0FBSyxHQUFHLENBQUMsRUFDYjtZQUNDLElBQUksR0FBRyxVQUFVLENBQUM7WUFDbEIsU0FBUyxHQUFHLGFBQWEsQ0FBQyxTQUFTLENBQUMsS0FBd0QsQ0FBQTtTQUM1RjthQUVEO1lBQ0MsSUFBSSxHQUFHLFVBQVUsQ0FBQyxLQUFLLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQ25DLFNBQVMsR0FBRyxVQUFVLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxLQUFLLENBQW9ELENBQUM7U0FDMUY7UUFFRCxNQUFNLE1BQU0sR0FBRztZQUNkLElBQUk7WUFDSixTQUFTLEVBQUUsU0FBc0Q7U0FDakUsQ0FBQztRQUVGLE9BQU8sTUFBTSxDQUFDO0lBQ2YsQ0FBQzs7QUFHRixXQUFVLGFBQWE7SUFHdEIsT0FBTyxNQUFNLEtBQUssUUFBUSxJQUFJLE1BQU0sQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLE9BQU8sRUFBRSxFQUFFLGFBQWEsRUFBRSxDQUFDLENBQUM7QUFDaEYsQ0FBQyxFQUpTLGFBQWEsS0FBYixhQUFhLFFBSXRCIiwic291cmNlc0NvbnRlbnQiOlsiXG5jbGFzcyBGaWxhQ2FwYWNpdG9yIGV4dGVuZHMgRmlsYVxue1xuXHQvKiogKi9cblx0c3RhdGljIGFzeW5jIHVzZSgpXG5cdHtcblx0XHRjb25zdCBjd2QgPSB0aGlzLmRpcmVjdG9yeS5kYXRhO1xuXHRcdGNvbnN0IHRtcCA9IHRoaXMuZGlyZWN0b3J5LmNhY2hlO1xuXHRcdGNvbnN0IHNlcCA9IFwiL1wiO1xuXHRcdEZpbGEuc2V0RGVmYXVsdHMoRmlsYUNhcGFjaXRvciwgc2VwLCBjd2QsIHRtcCk7XG5cdH1cblx0XG5cdC8qKiBWYWx1ZXMgY29waWVkIGZyb20gQ2FwYWNpdG9yLiAqL1xuXHRzdGF0aWMgcmVhZG9ubHkgZGlyZWN0b3J5ID0ge1xuXHRcdGNhY2hlOiBcIkNBQ0hFXCIsXG5cdFx0ZGF0YTogXCJEQVRBXCIsXG5cdFx0ZG9jdW1lbnRzOiBcIkRPQ1VNRU5UU1wiLFxuXHRcdGV4dGVybmFsOiBcIkVYVEVSTkFMXCIsXG5cdFx0ZXh0ZXJuYWxTdG9yYWdlOiBcIkVYVEVSTkFMX1NUT1JBR0VcIixcblx0XHRsaWJyYXJ5OiBcIkxJQlJBUllcIixcblx0fSBhcyBjb25zdDtcblx0XG5cdC8qKiAqL1xuXHRwcml2YXRlIGdldCBmcygpXG5cdHtcblx0XHRjb25zdCBnID0gZ2xvYmFsVGhpcyBhcyBhbnk7XG5cdFx0Y29uc3QgZnMgPSBnLkNhcGFjaXRvcj8uUGx1Z2lucz8uRmlsZXN5c3RlbTtcblx0XHRpZiAoIWZzKVxuXHRcdFx0dGhyb3cgbmV3IEVycm9yKFwiRmlsZXN5c3RlbSBwbHVnaW4gbm90IGFkZGVkIHRvIENhcGFjaXRvci5cIik7XG5cdFx0XG5cdFx0cmV0dXJuIGZzIGFzIHR5cGVvZiBpbXBvcnQoXCJAY2FwYWNpdG9yL2ZpbGVzeXN0ZW1cIikuRmlsZXN5c3RlbTtcblx0fVxuXHRcblx0LyoqXG5cdCAqIEdldHMgdGhlIGZ1bGx5LXF1YWxpZmllZCBwYXRoLCBpbmNsdWRpbmcgYW55IGZpbGUgbmFtZSB0byB0aGVcblx0ICogZmlsZSBzeXN0ZW0gb2JqZWN0IGJlaW5nIHJlcHJlc2VudGVkIGJ5IHRoaXMgRmlsYSBvYmplY3QuXG5cdCAqL1xuXHRnZXQgcGF0aCgpXG5cdHtcblx0XHRyZXR1cm4gRmlsYS5qb2luKC4uLnRoaXMuY29tcG9uZW50cyk7XG5cdH1cblx0XG5cdC8qKiAqL1xuXHRhc3luYyByZWFkVGV4dCgpXG5cdHtcblx0XHRjb25zdCByZXN1bHQgPSBhd2FpdCB0aGlzLmZzLnJlYWRGaWxlKHtcblx0XHRcdC4uLnRoaXMuZ2V0RGVmYXVsdE9wdGlvbnMoKSxcblx0XHRcdGVuY29kaW5nOiBcInV0ZjhcIiBhcyBhbnlcblx0XHR9KTtcblx0XHRcblx0XHRyZXR1cm4gcmVzdWx0LmRhdGE7XG5cdH1cblx0XG5cdC8qKiAqL1xuXHRhc3luYyByZWFkQmluYXJ5KClcblx0e1xuXHRcdGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRoaXMuZnMucmVhZEZpbGUoe1xuXHRcdFx0Li4udGhpcy5nZXREZWZhdWx0T3B0aW9ucygpLFxuXHRcdFx0ZW5jb2Rpbmc6IFwiYXNjaWlcIiBhcyBhbnlcblx0XHR9KTtcblx0XHRcblx0XHRjb25zdCBiYXNlNjQgPSByZXN1bHQuZGF0YTtcblx0XHRyZXR1cm4gVWludDhBcnJheS5mcm9tKGF0b2IoYmFzZTY0KSwgYyA9PiBjLmNoYXJDb2RlQXQoMCkpO1xuXHR9XG5cdFxuXHQvKiogKi9cblx0YXN5bmMgcmVhZERpcmVjdG9yeSgpXG5cdHtcblx0XHRjb25zdCByZXN1bHQgPSBhd2FpdCB0aGlzLmZzLnJlYWRkaXIodGhpcy5nZXREZWZhdWx0T3B0aW9ucygpKTtcblx0XHRjb25zdCBmaWxhczogRmlsYVtdID0gW107XG5cdFx0XG5cdFx0Zm9yIChjb25zdCBmaWxlIG9mIHJlc3VsdC5maWxlcylcblx0XHRcdGlmIChmaWxlLm5hbWUgIT09IFwiLkRTX1N0b3JlXCIpXG5cdFx0XHRcdGZpbGFzLnB1c2goRmlsYS5uZXcodGhpcy5wYXRoLCBmaWxlLm5hbWUgfHwgXCJcIikpO1xuXHRcdFxuXHRcdHJldHVybiBmaWxhcztcblx0fVxuXHRcblx0LyoqICovXG5cdGFzeW5jIHdyaXRlVGV4dCh0ZXh0OiBzdHJpbmcsIG9wdGlvbnM/OiBGaWxhLklXcml0ZVRleHRPcHRpb25zKVxuXHR7XG5cdFx0dHJ5XG5cdFx0e1xuXHRcdFx0Y29uc3QgdXAgPSB0aGlzLnVwKCk7XG5cdFx0XHRpZiAoIWF3YWl0IHVwLmV4aXN0cygpKVxuXHRcdFx0XHRhd2FpdCB1cC53cml0ZURpcmVjdG9yeSgpO1xuXHRcdFx0XG5cdFx0XHRjb25zdCB3cml0ZU9wdGlvbnMgPSB7XG5cdFx0XHRcdC4uLnRoaXMuZ2V0RGVmYXVsdE9wdGlvbnMoKSxcblx0XHRcdFx0ZGF0YTogdGV4dCxcblx0XHRcdFx0ZW5jb2Rpbmc6IFwidXRmOFwiIGFzIGFueVxuXHRcdFx0fTtcblx0XHRcdFxuXHRcdFx0aWYgKG9wdGlvbnM/LmFwcGVuZClcblx0XHRcdFx0YXdhaXQgdGhpcy5mcy5hcHBlbmRGaWxlKHdyaXRlT3B0aW9ucyk7XG5cdFx0XHRlbHNlXG5cdFx0XHRcdGF3YWl0IHRoaXMuZnMud3JpdGVGaWxlKHdyaXRlT3B0aW9ucyk7XG5cdFx0fVxuXHRcdGNhdGNoIChlKVxuXHRcdHtcblx0XHRcdGNvbnNvbGUuZXJyb3IoXCJXcml0ZSBmYWlsZWQgdG8gcGF0aDogXCIgKyB0aGlzLnBhdGgpO1xuXHRcdFx0ZGVidWdnZXI7XG5cdFx0fVxuXHR9XG5cdFxuXHQvKiogKi9cblx0YXN5bmMgd3JpdGVCaW5hcnkoYXJyYXlCdWZmZXI6IEFycmF5QnVmZmVyKVxuXHR7XG5cdFx0YXdhaXQgdGhpcy51cCgpLndyaXRlRGlyZWN0b3J5KCk7XG5cdFx0Y29uc3QgZGF0YSA9IGF3YWl0IHRoaXMuYXJyYXlCdWZmZXJUb0Jhc2U2NChhcnJheUJ1ZmZlcik7XG5cdFx0YXdhaXQgdGhpcy5mcy53cml0ZUZpbGUoe1xuXHRcdFx0Li4udGhpcy5nZXREZWZhdWx0T3B0aW9ucygpLFxuXHRcdFx0ZGF0YSxcblx0XHRcdGVuY29kaW5nOiBcImFzY2lpXCIgYXMgYW55XG5cdFx0fSk7XG5cdH1cblx0XG5cdC8qKiAqL1xuXHRwcml2YXRlIGFycmF5QnVmZmVyVG9CYXNlNjQoYnVmZmVyOiBBcnJheUJ1ZmZlcilcblx0e1xuXHRcdHJldHVybiBuZXcgUHJvbWlzZTxzdHJpbmc+KHIgPT5cblx0XHR7XG5cdFx0XHRjb25zdCBibG9iID0gbmV3IEJsb2IoW2J1ZmZlcl0sIHsgdHlwZTogXCJhcHBsaWNhdGlvbi9vY3RldC1iaW5hcnlcIiB9KTtcblx0XHRcdGNvbnN0IHJlYWRlciA9IG5ldyBGaWxlUmVhZGVyKCk7XG5cdFx0XHRcblx0XHRcdHJlYWRlci5vbmxvYWQgPSBldiA9PlxuXHRcdFx0e1xuXHRcdFx0XHRjb25zdCBkYXRhVXJsID0gKGV2LnRhcmdldD8ucmVzdWx0IHx8IFwiXCIpIGFzIHN0cmluZztcblx0XHRcdFx0Y29uc3Qgc2xpY2UgPSBkYXRhVXJsLnNsaWNlKGRhdGFVcmwuaW5kZXhPZihgLGApICsgMSk7XG5cdFx0XHRcdHIoc2xpY2UpO1xuXHRcdFx0fTtcblx0XHRcdHJlYWRlci5yZWFkQXNEYXRhVVJMKGJsb2IpO1xuXHRcdH0pO1xufVxuXHRcblx0LyoqICovXG5cdGFzeW5jIHdyaXRlRGlyZWN0b3J5KClcblx0e1xuXHRcdGF3YWl0IHRoaXMuZnMubWtkaXIoe1xuXHRcdFx0Li4udGhpcy5nZXREZWZhdWx0T3B0aW9ucygpLFxuXHRcdFx0cmVjdXJzaXZlOiB0cnVlXG5cdFx0fSk7XG5cdH1cblx0XG5cdC8qKlxuXHQgKiBXcml0ZXMgYSBzeW1saW5rIGZpbGUgYXQgdGhlIGxvY2F0aW9uIHJlcHJlc2VudGVkIGJ5IHRoZSBzcGVjaWZpZWRcblx0ICogRmlsYSBvYmplY3QsIHRvIHRoZSBsb2NhdGlvbiBzcGVjaWZpZWQgYnkgdGhlIGN1cnJlbnQgRmlsYSBvYmplY3QuXG5cdCAqL1xuXHRhc3luYyB3cml0ZVN5bWxpbmsoYXQ6IEZpbGEpXG5cdHtcblx0XHR0aHJvdyBuZXcgRXJyb3IoXCJOb3QgaW1wbGVtZW50ZWRcIik7XG5cdH1cblx0XG5cdC8qKlxuXHQgKiBEZWxldGVzIHRoZSBmaWxlIG9yIGRpcmVjdG9yeSB0aGF0IHRoaXMgRmlsYSBvYmplY3QgcmVwcmVzZW50cy5cblx0ICovXG5cdGFzeW5jIGRlbGV0ZSgpOiBQcm9taXNlPEVycm9yIHwgdm9pZD5cblx0e1xuXHRcdGlmIChhd2FpdCB0aGlzLmlzRGlyZWN0b3J5KCkpXG5cdFx0e1xuXHRcdFx0cmV0dXJuIG5ldyBQcm9taXNlPEVycm9yIHwgdm9pZD4oYXN5bmMgciA9PlxuXHRcdFx0e1xuXHRcdFx0XHRhd2FpdCB0aGlzLmZzLnJtZGlyKHtcblx0XHRcdFx0XHQuLi50aGlzLmdldERlZmF1bHRPcHRpb25zKCksXG5cdFx0XHRcdFx0cmVjdXJzaXZlOiB0cnVlXG5cdFx0XHRcdH0pO1xuXHRcdFx0XHRcblx0XHRcdFx0cigpO1xuXHRcdFx0fSk7XG5cdFx0fVxuXHRcdFxuXHRcdGF3YWl0IHRoaXMuZnMuZGVsZXRlRmlsZSh0aGlzLmdldERlZmF1bHRPcHRpb25zKCkpO1xuXHR9XG5cdFxuXHQvKiogKi9cblx0YXN5bmMgbW92ZSh0YXJnZXQ6IEZpbGEpXG5cdHtcblx0XHR0aHJvdyBuZXcgRXJyb3IoXCJOb3QgaW1wbGVtZW50ZWQuXCIpO1xuXHR9XG5cdFxuXHQvKiogKi9cblx0YXN5bmMgY29weSh0YXJnZXQ6IEZpbGEpXG5cdHtcblx0XHRjb25zdCBmcm9tT3B0aW9ucyA9IHRoaXMuZ2V0RGVmYXVsdE9wdGlvbnMoKTtcblx0XHRjb25zdCB0b09wdGlvbnMgPSB0aGlzLmdldERlZmF1bHRPcHRpb25zKHRhcmdldC5wYXRoKTtcblx0XHRcblx0XHRhd2FpdCB0aGlzLmZzLmNvcHkoe1xuXHRcdFx0ZnJvbTogZnJvbU9wdGlvbnMucGF0aCxcblx0XHRcdGRpcmVjdG9yeTogZnJvbU9wdGlvbnMuZGlyZWN0b3J5LFxuXHRcdFx0dG86IHRvT3B0aW9ucy5wYXRoLFxuXHRcdFx0dG9EaXJlY3Rvcnk6IHRvT3B0aW9ucy5kaXJlY3RvcnksXG5cdFx0fSk7XG5cdH1cblx0XG5cdC8qKiAqL1xuXHRhc3luYyByZW5hbWUobmV3TmFtZTogc3RyaW5nKVxuXHR7XG5cdFx0Y29uc3QgdGFyZ2V0ID0gdGhpcy51cCgpLmRvd24obmV3TmFtZSkucGF0aDtcblx0XHRjb25zdCBmcm9tT3B0aW9ucyA9IHRoaXMuZ2V0RGVmYXVsdE9wdGlvbnMoKTtcblx0XHRjb25zdCB0b09wdGlvbnMgPSB0aGlzLmdldERlZmF1bHRPcHRpb25zKHRhcmdldCk7XG5cdFx0XG5cdFx0YXdhaXQgdGhpcy5mcy5yZW5hbWUoe1xuXHRcdFx0ZnJvbTogdGhpcy5wYXRoLFxuXHRcdFx0ZGlyZWN0b3J5OiBmcm9tT3B0aW9ucy5kaXJlY3RvcnksXG5cdFx0XHR0bzogdGFyZ2V0LFxuXHRcdFx0dG9EaXJlY3Rvcnk6IHRvT3B0aW9ucy5kaXJlY3Rvcnlcblx0XHR9KTtcblx0fVxuXHRcblx0LyoqICovXG5cdHByb3RlY3RlZCB3YXRjaFByb3RlY3RlZChcblx0XHRyZWN1cnNpdmU6IGJvb2xlYW4sXG5cdFx0Y2FsbGJhY2tGbjogKGV2ZW50OiBGaWxhLkV2ZW50LCBmaWxhOiBGaWxhKSA9PiB2b2lkKTogKCkgPT4gdm9pZFxuXHR7XG5cdFx0dGhyb3cgbmV3IEVycm9yKFwiTm90IGltcGxlbWVudGVkXCIpO1xuXHR9XG5cdFxuXHQvKiogKi9cblx0YXN5bmMgZXhpc3RzKClcblx0e1xuXHRcdHJldHVybiAhIWF3YWl0IHRoaXMuZ2V0U3RhdCgpO1xuXHR9XG5cdFxuXHQvKiogKi9cblx0YXN5bmMgZ2V0U2l6ZSgpXG5cdHtcblx0XHRyZXR1cm4gKGF3YWl0IHRoaXMuZ2V0U3RhdCgpKT8uc2l6ZSB8fCAwO1xuXHR9XG5cdFxuXHQvKiogKi9cblx0YXN5bmMgZ2V0TW9kaWZpZWRUaWNrcygpXG5cdHtcblx0XHRyZXR1cm4gKGF3YWl0IHRoaXMuZ2V0U3RhdCgpKT8ubXRpbWUgfHwgMDtcblx0fVxuXHRcblx0LyoqICovXG5cdGFzeW5jIGdldENyZWF0ZWRUaWNrcygpXG5cdHtcblx0XHRyZXR1cm4gKGF3YWl0IHRoaXMuZ2V0U3RhdCgpKT8uY3RpbWUgfHwgMDtcblx0fVxuXHRcblx0LyoqICovXG5cdGFzeW5jIGdldEFjY2Vzc2VkVGlja3MoKVxuXHR7XG5cdFx0cmV0dXJuIDA7XG5cdH1cblx0XG5cdC8qKiAqL1xuXHRhc3luYyBpc0RpcmVjdG9yeSgpXG5cdHtcblx0XHRyZXR1cm4gKGF3YWl0IHRoaXMuZ2V0U3RhdCgpKT8udHlwZSA9PT0gXCJkaXJlY3RvcnlcIjtcblx0fVxuXHRcblx0LyoqICovXG5cdHByaXZhdGUgYXN5bmMgZ2V0U3RhdCgpXG5cdHtcblx0XHR0cnlcblx0XHR7XG5cdFx0XHRyZXR1cm4gYXdhaXQgdGhpcy5mcy5zdGF0KHRoaXMuZ2V0RGVmYXVsdE9wdGlvbnMoKSk7XG5cdFx0fVxuXHRcdGNhdGNoIChlKSB7IHJldHVybiBudWxsOyB9XG5cdH1cblx0XG5cdC8qKiAqL1xuXHRwcml2YXRlIGdldERlZmF1bHRPcHRpb25zKHRhcmdldFBhdGg6IHN0cmluZyA9IHRoaXMucGF0aClcblx0e1xuXHRcdGNvbnN0IHNsYXNoID0gdGFyZ2V0UGF0aC5pbmRleE9mKFwiL1wiKTtcblx0XHRsZXQgcGF0aCA9IFwiXCI7XG5cdFx0bGV0IGRpcmVjdG9yeSA9IFwiXCI7XG5cdFx0XG5cdFx0aWYgKHNsYXNoIDwgMClcblx0XHR7XG5cdFx0XHRwYXRoID0gdGFyZ2V0UGF0aDtcblx0XHRcdGRpcmVjdG9yeSA9IEZpbGFDYXBhY2l0b3IuZGlyZWN0b3J5LmNhY2hlIGFzIGltcG9ydChcIkBjYXBhY2l0b3IvZmlsZXN5c3RlbVwiKS5EaXJlY3RvcnkuQ2FjaGVcblx0XHR9XG5cdFx0ZWxzZVxuXHRcdHtcblx0XHRcdHBhdGggPSB0YXJnZXRQYXRoLnNsaWNlKHNsYXNoICsgMSk7XG5cdFx0XHRkaXJlY3RvcnkgPSB0YXJnZXRQYXRoLnNsaWNlKDAsIHNsYXNoKSBhcyBpbXBvcnQoXCJAY2FwYWNpdG9yL2ZpbGVzeXN0ZW1cIikuRGlyZWN0b3J5LkNhY2hlO1xuXHRcdH1cblx0XHRcblx0XHRjb25zdCByZXN1bHQgPSB7XG5cdFx0XHRwYXRoLFxuXHRcdFx0ZGlyZWN0b3J5OiBkaXJlY3RvcnkgYXMgaW1wb3J0KFwiQGNhcGFjaXRvci9maWxlc3lzdGVtXCIpLkRpcmVjdG9yeVxuXHRcdH07XG5cdFx0XG5cdFx0cmV0dXJuIHJlc3VsdDtcblx0fVxufVxuXG5uYW1lc3BhY2UgRmlsYUNhcGFjaXRvclxue1xuXHRkZWNsYXJlIGNvbnN0IG1vZHVsZTogYW55O1xuXHR0eXBlb2YgbW9kdWxlID09PSBcIm9iamVjdFwiICYmIE9iamVjdC5hc3NpZ24obW9kdWxlLmV4cG9ydHMsIHsgRmlsYUNhcGFjaXRvciB9KTtcbn0iXX0=